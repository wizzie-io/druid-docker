machine:
  services:
    - docker
  java:
    version: openjdk8
  environment:
    JAVA_OPTIONS: "-Xms512m -Xmx1024m"

dependencies:
  override:
    - mvn -Dmaven.test.skip=true install
deployment:
  master:
    branch: master
    commands:
      - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
      - /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
      - /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
      - docker login -u oauth2accesstoken -e circleci@wizzie-registry.iam.gserviceaccount.com -p "$(gcloud auth application-default print-access-token)" https://gcr.io
      - docker build -t gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_SHA1 .
      - docker tag gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_SHA1 gcr.io/$GCLOUD_PROJECT/druid:latest
      - gcloud docker -- push gcr.io/$GCLOUD_PROJECT/druid:latest
  release:
    tag: /druid-docker-.*/
    commands:
      - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
      - /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
      - /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
      - docker login -u oauth2accesstoken -e circleci@wizzie-registry.iam.gserviceaccount.com -p "$(gcloud auth application-default print-access-token)" https://gcr.io
      - docker build -t gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_SHA1 .
      - docker tag gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_SHA1 gcr.io/$GCLOUD_PROJECT/druid:latest
      - docker tag gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_SHA1 gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_TAG
      - gcloud docker -- push gcr.io/$GCLOUD_PROJECT/druid:latest
      - gcloud docker -- push gcr.io/$GCLOUD_PROJECT/druid:$CIRCLE_TAG 
